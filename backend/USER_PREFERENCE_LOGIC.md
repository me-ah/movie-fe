# MEAH 유저 취향 반영 및 추천 로직 가이드

본 문서는 사용자의 행동이 어떻게 백엔드 데이터에 반영되고, 이를 기반으로 어떤 추천 알고리즘이 작동하는지 상세히 설명합니다.

---

## 1. 취향 데이터 수집 (Data Collection)

### (1) 온보딩 (초기 데이터)
- **행위:** 가입 후 최초 1회 선호 장르 선택.
- **반영:** 선택한 각 장르 필드(`pref_...`)에 **즉시 +50점** 가산.
- **목적:** '콜드 스타트(데이터가 없는 초기 상태)' 문제 해결.

### (2) 시청 기록 (지속적 데이터)
- **행위:** 쇼츠 영상 시청.
- **반영:** 시청 시간(`watch_time`)이 **3초 이상**일 때만 해당 영화의 모든 장르 점수에 시청 시간을 더함.
- **예시:** 액션/로맨스 영화를 50초 시청 시 -> `pref_action +50`, `pref_romance +50`.
- **필터링:** 3초 미만 시청은 '단순 넘기기'로 간주하여 점수에 반영하지 않음 (데이터 오염 방지).

---

## 2. 점수 산정 및 랭킹 (Scoring & Ranking)

### (1) 단일 장르 점수
- 유저 테이블의 각 `pref_` 필드 값을 그대로 사용.

### (2) 혼합 장르 점수 (중요)
- 카테고리가 여러 장르의 조합(예: 액션|코미디)인 경우, 해당 장르들의 **평균값**을 계산.
- **공식:** `(장르A 점수 + 장르B 점수 + ...) / 장르 개수`
- **이유:** 특정 장르 점수가 너무 높아서 혼합 장르 카테고리가 상위권을 독점하는 것을 방지하고 밸런스를 맞춤.

---

## 3. 추천 알고리즘 (Recommendation Engine)

### (1) 홈 화면 서브 레일 (Sub View)
- 전체 471개 카테고리 후보군을 유저의 **혼합 장르 평균 점수**순으로 정렬.
- 상위 3개는 공통 스페셜(인기작 등) 고정, 4번 레일부터 유저 취향순으로 배치.

### (2) 개인화 쇼츠 믹스 (Shorts View)
- **20개 단위 배치(Batch) 생성:**
    - **Top 취향 (12개):** 선호도 상위 5개 카테고리에서 Round-Robin 방식으로 수집.
    - **중간 발견 (4개):** 선호도 10~15위 카테고리에서 수집 (취향 확장용).
    - **트렌딩 (4개):** 지금 뜨는 콘텐츠 등 스페셜 카테고리에서 수집.
- **중복 및 시청 제외:** 현재 큐(Queue)에 있는 영화와 최근 본 500개 영화(`UserMovieHistory`)를 제외.
- **무한 로딩:** 10개를 보면 다음 20개를 미리 준비하여 Redis에 저장.

### (3) 영화 상세 관련 추천 (Detail View)
- 현재 영화의 장르 조합(예: 애니메이션|SF)과 **100% 일치하는 카테고리**를 찾아 그 안의 영화들을 우선 추천.
- 일치하는 카테고리가 없으면 해당 영화를 포함하는 가장 유사한 레일을 선택.

---

## 4. 데이터 초기화 및 갱신
- **갱신 주기:** `refresh_home` 명령어를 통해 주기적으로 카테고리 내 영화 리스트 최신화.
- **점수 보존:** 유저 탈퇴 전까지 취향 점수는 누적되며, 온보딩은 1회 완료 후 고정됨.
